<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI å›¾åƒ/è§†é¢‘å¤„ç†å™¨</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container { 
            max-width: 1000px; 
            margin: auto; 
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .mode-switch {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .mode-btn {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .mode-btn.active {
            background: #007bff;
            color: white;
        }
        .mode-btn:hover {
            background: #0056b3;
            color: white;
        }
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #218838;
        }
        .media-container {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }
        .media-section {
            flex: 1;
        }
        .media-section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        img, video { 
            max-width: 100%; 
            max-height: 400px;
            border: 2px solid #ddd;
            border-radius: 5px;
            display: block;
            margin: 10px 0;
        }
        #result-text {
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            color: #155724;
            margin-top: 10px;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§  ComfyUI å›¾åƒ/è§†é¢‘å¤„ç†å™¨</h1>
        <p>ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘ï¼Œé€‰æ‹©æ¨¡æ¿ï¼Œè°ƒç”¨ ComfyUI å·¥ä½œæµè¿›è¡Œå¤„ç†</p>

        <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
        <div class="mode-switch">
            <button class="mode-btn active" id="image-mode-btn">ğŸ“· å›¾ç‰‡å¤„ç†</button>
            <button class="mode-btn" id="video-mode-btn">ğŸ¬ è§†é¢‘å¤„ç†</button>
        </div>

        <!-- æ¨¡æ¿é€‰æ‹© -->
        <div class="control-group">
            <label for="template">é€‰æ‹©æ¨¡æ¿ï¼š</label>
            <select id="template"></select>
            <button id="load-template">åŠ è½½æ¨¡æ¿</button>
            <p id="load-status"></p>
        </div>

        <!-- å›¾ç‰‡å¤„ç†åŒºåŸŸ -->
        <div id="image-section" class="control-group">
            <label for="image">ä¸Šä¼ å›¾ç‰‡ï¼š</label>
            <input type="file" id="image" accept="image/*">
            <button id="submit-image">æäº¤å¤„ç†</button>
        </div>

        <!-- è§†é¢‘å¤„ç†åŒºåŸŸ -->
        <div id="video-section" class="control-group hidden">
            <label for="video-image">ä¸Šä¼ å›¾ç‰‡ï¼ˆç”¨äºè§†é¢‘æ¢è„¸ï¼‰ï¼š</label>
            <input type="file" id="video-image" accept="image/*">
            <button id="submit-video">æäº¤å¤„ç†</button>
        </div>

        <!-- åª’ä½“æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="media-container">
            <div class="media-section">
                <h2 id="original-title">åŸå§‹å›¾ç‰‡</h2>
                <img id="original-image" alt="åŸå§‹å›¾ç‰‡" class="hidden">
                <video id="original-video" controls class="hidden">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
            </div>

            <div class="media-section">
                <h2 id="processed-title">å¤„ç†ç»“æœ</h2>
                <img id="processed-image" alt="å¤„ç†ç»“æœ" class="hidden">
                <video id="processed-video" controls class="hidden">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
                <div id="loading" class="loading hidden">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
                <p id="result-text"></p>
            </div>
        </div>
    </div>

    <script>
        // å°† API åœ°å€æ”¹ä¸ºå½“å‰é¡µé¢æ¥æºï¼Œé¿å… 127.0.0.1 ä¸ localhost ä¸ä¸€è‡´å¯¼è‡´çš„é—®é¢˜
        const API_BASE = window.location.origin;
        let currentMode = 'image'; // é»˜è®¤ä¸ºå›¾ç‰‡æ¨¡å¼

        // æ¨¡å¼åˆ‡æ¢
        document.getElementById('image-mode-btn').addEventListener('click', () => switchMode('image'));
        document.getElementById('video-mode-btn').addEventListener('click', () => switchMode('video'));

        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('image-mode-btn').classList.toggle('active', mode === 'image');
            document.getElementById('video-mode-btn').classList.toggle('active', mode === 'video');
            
            // æ˜¾ç¤º/éšè—ç›¸åº”çš„ä¸Šä¼ åŒºåŸŸ
            document.getElementById('image-section').classList.toggle('hidden', mode !== 'image');
            document.getElementById('video-section').classList.toggle('hidden', mode !== 'video');
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('original-title').textContent = mode === 'image' ? 'åŸå§‹å›¾ç‰‡' : 'å‚è€ƒå›¾ç‰‡';
            document.getElementById('processed-title').textContent = mode === 'image' ? 'å¤„ç†ç»“æœ' : 'å¤„ç†ç»“æœ';
            
            // é‡ç½®æ˜¾ç¤ºåŒºåŸŸ
            resetMediaDisplay();
            
            // é‡æ–°åŠ è½½å¯¹åº”æ¨¡å¼çš„æ¨¡æ¿åˆ—è¡¨
            fetchTemplates(mode);
        }

        function resetMediaDisplay() {
            // éšè—æ‰€æœ‰åª’ä½“å…ƒç´ 
            document.getElementById('original-image').classList.add('hidden');
            document.getElementById('original-video').classList.add('hidden');
            document.getElementById('processed-image').classList.add('hidden');
            document.getElementById('processed-video').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('result-text').textContent = '';
        }

        // è·å–æ¨¡æ¿åˆ—è¡¨
        async function fetchTemplates(mode = currentMode) {
            try {
                const response = await fetch(`${API_BASE}/templates?mode=${mode}`);
                const data = await response.json();
                const select = document.getElementById('template');
                select.innerHTML = '';
                
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t;
                        option.textContent = t;
                        select.appendChild(option);
                    });
                    document.getElementById('load-status').textContent = `å·²åŠ è½½${mode === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}æ¨¡å¼çš„æ¨¡æ¿åˆ—è¡¨`;
                } else {
                    document.getElementById('load-status').textContent = data.message || `æ²¡æœ‰æ‰¾åˆ°${mode === 'image' ? 'å›¾ç‰‡' : 'è§†é¢‘'}æ¨¡å¼çš„æ¨¡æ¿`;
                }
            } catch (error) {
                console.error('è·å–æ¨¡æ¿å¤±è´¥:', error);
                document.getElementById('result-text').textContent = 'è·å–æ¨¡æ¿å¤±è´¥: ' + error.message;
            }
        }

        // åŠ è½½æ¨¡æ¿
        async function loadTemplate() {
            try {
                const template = document.getElementById('template').value;
                if (!template) {
                    document.getElementById('load-status').textContent = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿';
                    return;
                }
                
                document.getElementById('load-status').textContent = 'æ­£åœ¨åŠ è½½æ¨¡æ¿...';
                
                const formData = new FormData();
                formData.append('template', template);
                formData.append('mode', currentMode);
                
                const response = await fetch(`${API_BASE}/load_template`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                document.getElementById('load-status').textContent = data.message;
            } catch (error) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', error);
                document.getElementById('load-status').textContent = 'åŠ è½½æ¨¡æ¿å¤±è´¥: ' + error.message;
            }
        }

        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('original-image');
                    img.src = ev.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('original-video').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // è§†é¢‘æ¨¡å¼ä¸‹çš„å›¾ç‰‡é¢„è§ˆï¼ˆç”¨äºæ¢è„¸ï¼‰
        document.getElementById('video-image').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('original-image');
                    img.src = ev.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('original-video').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // å¤„ç†å›¾ç‰‡
        async function processImage() {
            const fileInput = document.getElementById('image');
            const template = document.getElementById('template').value;
            if (!fileInput.files[0]) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('processed-image').classList.add('hidden');
            document.getElementById('result-text').textContent = 'å¤„ç†ä¸­...';

            try {
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('template', template);
                formData.append('mode', 'image');

                const response = await fetch(`${API_BASE}/process_image`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                document.getElementById('loading').classList.add('hidden');

                if (data.status === 'success' && data.processed_image_base64) {
                    // æ˜¾ç¤ºå¤„ç†ç»“æœï¼ˆbase64è½¬Data URLï¼‰
                    const img = document.getElementById('processed-image');
                    img.src = `data:image/png;base64,${data.processed_image_base64}`;
                    img.classList.remove('hidden');
                    document.getElementById('result-text').textContent = data.message;
                } else {
                    document.getElementById('result-text').textContent = data.message || 'å¤„ç†å¤±è´¥';
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                console.error('å¤„ç†å›¾ç‰‡å¤±è´¥:', error);
                document.getElementById('result-text').textContent = 'å¤„ç†å›¾ç‰‡å¤±è´¥: ' + error.message;
            }
        }

        // å¤„ç†è§†é¢‘
        async function processVideo() {
            const fileInput = document.getElementById('video-image');
            const template = document.getElementById('template').value;
            if (!fileInput.files[0]) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('processed-video').classList.add('hidden');
            document.getElementById('result-text').textContent = 'å¤„ç†ä¸­...ï¼ˆè§†é¢‘å¤„ç†å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰';

            try {
                const formData = new FormData();
                formData.append('image', fileInput.files[0]);
                formData.append('template', template);
                formData.append('mode', 'video');

                const response = await fetch(`${API_BASE}/process_video`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                document.getElementById('loading').classList.add('hidden');

                if (data.status === 'success' && data.processed_video_base64) {
                    // æ˜¾ç¤ºå¤„ç†ç»“æœï¼ˆbase64è½¬Data URLï¼‰
                    const video = document.getElementById('processed-video');
                    video.src = `data:video/mp4;base64,${data.processed_video_base64}`;
                    video.classList.remove('hidden');
                    document.getElementById('result-text').textContent = data.message;
                } else {
                    document.getElementById('result-text').textContent = data.message || 'å¤„ç†å¤±è´¥';
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                console.error('å¤„ç†è§†é¢‘å¤±è´¥:', error);
                document.getElementById('result-text').textContent = 'å¤„ç†è§†é¢‘å¤±è´¥: ' + error.message;
            }
        }

        // æŒ‰é’®äº‹ä»¶
        document.getElementById('load-template').addEventListener('click', loadTemplate);
        document.getElementById('submit-image').addEventListener('click', processImage);
        document.getElementById('submit-video').addEventListener('click', processVideo);

        // åˆå§‹åŒ–
        fetchTemplates();
    </script>
</body>
</html>